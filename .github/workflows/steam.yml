name: "Steam Deploy"

on:
  push:
    tags:
      - "v*"

env:
  STEAMWORKS_SDK_COMMIT: "494c2d680b9e47bbc369496b57568f44ef2f6796"

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - variant: production
            steam_app_id: "4313790"
          - variant: playtest
            steam_app_id: "4313850"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Download Steamworks SDK
        shell: pwsh
        run: |
          $commit = "$env:STEAMWORKS_SDK_COMMIT"
          Invoke-WebRequest -Uri "https://github.com/rlabrecque/SteamworksSDK/archive/$commit.zip" -OutFile "steamworks_sdk.zip"
          Expand-Archive -Path "steamworks_sdk.zip" -DestinationPath "."
          Move-Item "SteamworksSDK-$commit" "steamworks_sdk"

      - name: Install Steam SDK library
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "src-tauri/resources"
          Copy-Item "steamworks_sdk/redistributable_bin/win64/steam_api64.dll" -Destination "src-tauri/resources/"

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_APP_ID: ${{ matrix.steam_app_id }}
        with:
          args: --features steam --config src-tauri/tauri.steam.conf.json

      - name: Prepare Windows artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path steam-build/windows
          Copy-Item "src-tauri/target/release/CM_Launcher.exe" -Destination "steam-build/windows/"
          Copy-Item "src-tauri/resources/steam_api64.dll" -Destination "steam-build/windows/"

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ matrix.variant }}
          path: steam-build/windows/
          retention-days: 1

  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - variant: production
            steam_app_id: "4313790"
          - variant: playtest
            steam_app_id: "4313850"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Download Steamworks SDK
        run: |
          curl -L "https://github.com/rlabrecque/SteamworksSDK/archive/$STEAMWORKS_SDK_COMMIT.zip" -o steamworks_sdk.zip
          unzip steamworks_sdk.zip
          mv "SteamworksSDK-$STEAMWORKS_SDK_COMMIT" steamworks_sdk

      - name: Install Steam SDK library
        run: |
          mkdir -p src-tauri/resources
          cp steamworks_sdk/redistributable_bin/linux64/libsteam_api.so src-tauri/resources/
          sudo cp steamworks_sdk/redistributable_bin/linux64/libsteam_api.so /usr/lib/
          sudo ldconfig

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPIMAGE_EXTRACT_AND_RUN: 1
          LD_LIBRARY_PATH: /usr/lib
          STEAM_APP_ID: ${{ matrix.steam_app_id }}
        with:
          args: --features steam --config src-tauri/tauri.steam.conf.json

      - name: Prepare Linux artifacts
        run: |
          mkdir -p steam-build/linux
          find src-tauri/target/release/bundle -name "*.AppImage" -exec cp {} steam-build/linux/ \;
          cp src-tauri/resources/libsteam_api.so steam-build/linux/

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-${{ matrix.variant }}
          path: steam-build/linux/
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - variant: production
            steam_app_id: "4313790"
          - variant: playtest
            steam_app_id: "4313850"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Download Steamworks SDK
        run: |
          curl -L "https://github.com/rlabrecque/SteamworksSDK/archive/$STEAMWORKS_SDK_COMMIT.zip" -o steamworks_sdk.zip
          unzip steamworks_sdk.zip
          mv "SteamworksSDK-$STEAMWORKS_SDK_COMMIT" steamworks_sdk

      - name: Install Steam SDK library
        run: |
          mkdir -p src-tauri/resources
          cp steamworks_sdk/redistributable_bin/osx/libsteam_api.dylib src-tauri/resources/

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app (Universal Binary)
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_APP_ID: ${{ matrix.steam_app_id }}
        with:
          args: --features steam --target universal-apple-darwin --config src-tauri/tauri.steam.conf.json

      - name: Prepare macOS artifacts
        run: |
          mkdir -p steam-build/macos

          APP_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            cp -R "$APP_PATH" steam-build/macos/
          fi
          cp src-tauri/resources/libsteam_api.dylib steam-build/macos/

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.variant }}
          path: steam-build/macos/
          retention-days: 1

  generate-steam-totp:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    outputs:
      totp: ${{ steps.steam-totp.outputs.code }}
    steps:
      - name: Generate Steam TOTP
        id: steam-totp
        uses: andriivitiv/steam-totp@v1
        with:
          shared_secret: ${{ secrets.STEAM_SHARED_SECRET }}

  deploy-steam-production:
    needs: [build-windows, build-linux, build-macos, generate-steam-totp]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Steam
        uses: ./.github/actions/steam-deploy
        with:
          variant: production
          steam_app_id: "4313790"
          steam_username: ${{ secrets.STEAM_USERNAME }}
          steam_password: ${{ secrets.STEAM_PASSWORD }}
          steam_totp: ${{ needs.generate-steam-totp.outputs.totp }}

  deploy-steam-playtest:
    needs: [build-windows, build-linux, build-macos, generate-steam-totp, deploy-steam-production]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Steam
        uses: ./.github/actions/steam-deploy
        with:
          variant: playtest
          steam_app_id: "4313850"
          steam_username: ${{ secrets.STEAM_USERNAME }}
          steam_password: ${{ secrets.STEAM_PASSWORD }}
          steam_totp: ${{ needs.generate-steam-totp.outputs.totp }}